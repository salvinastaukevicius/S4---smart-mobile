<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <title>Document</title>
  </head>
  <body>
    <h1 id="steps">Fetching data</h1>
    <h2 id="calories">Fetching data</h2>

    <script>
      // Get the authorization code from the URL query parameters
      const code = new URLSearchParams(window.location.search).get("code");

      // Send a POST request to the token endpoint to exchange the code for an access token
      const data = {
        code: code,
        client_id:
          "643398672506-a5k2fjtmk0hsljf90qli3jiibebalpok.apps.googleusercontent.com",
        client_secret: "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",
        redirect_uri: "http://localhost:5500/pwa/redirect.html",
        //   redirect_uri: 'https://i481136.hera.fhict.nl/redirect.html',
        grant_type: "authorization_code",
      };

      fetch("https://oauth2.googleapis.com/token", {
        method: "POST",
        body: JSON.stringify(data),
        headers: {
          "Content-Type": "application/json",
        },
      })
        .then((response) => response.json())
        .then((data) => {
          const accessToken = data.access_token;
          localStorage.setItem('token', accessToken)
          caloriesData(accessToken);
          stepsData(accessToken);
        });

      //getting fitness data

      var endTimeMillis = new Date().getTime(); //right now

      const today = new Date(); //start of the day
      today.setHours(0, 0, 0, 0);
      var startTimeMillis = today.getTime();

      

      function caloriesData(data) {
        mydata = data;
        console.log("Access token:", mydata);

        fetch(
          "https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + mydata,
            },
            body: JSON.stringify(requestBody_calories),
          }
        )
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            var steps = data.bucket[0].dataset[0].point[0].value[0].fpVal;
            let small_steps = steps.toFixed(0);
            var stepsElement = document.getElementById("calories");
            stepsElement.innerHTML = small_steps + " kcal";
            console.log(small_steps);
          })
          .catch((error) => {
            console.error(error);
          });

        console.log(steps);
      }

      function stepsData(data) {
        mydata = data;
        console.log("Access token:", mydata);

        fetch(
          "https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + mydata,
            },
            body: JSON.stringify(requestBody_steps),
          }
        )
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            var steps = data.bucket[0].dataset[0].point[0].value[0].intVal;
            var stepsElement = document.getElementById("steps");
            stepsElement.innerHTML = steps + " steps";
            console.log(steps);
          })
          .catch((error) => {
            console.error(error);
          });

        console.log(steps);
      }

      var requestBody_calories = {
        aggregateBy: [
          {
            dataTypeName: "com.google.calories.expended",
            dataSourceId:
              "derived:com.google.calories.expended:com.google.android.gms:merge_calories_expended",
          },
        ],
        bucketByTime: { durationMillis: 86400000 },
        startTimeMillis: startTimeMillis,
        endTimeMillis: endTimeMillis,
      };

      var requestBody_steps = {
        aggregateBy: [
          {
            dataTypeName: "com.google.step_count.delta",
            dataSourceId:
              "derived:com.google.step_count.delta:com.google.android.gms:estimated_steps",
          },
        ],
        bucketByTime: { durationMillis: 86400000 },
        startTimeMillis: startTimeMillis,
        endTimeMillis: endTimeMillis,
      };

    </script>
  </body>
</html>
